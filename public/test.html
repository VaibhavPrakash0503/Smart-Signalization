<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script async defer src ="https://maps.googleapis.com/maps/api/js?key=AIzaSyA7bzgLrMKMMzKdsdyzix9xUQ9XXPUS3X4"></script>
    <script>
        let markers = []; // Array to store marker references
        let nearbymarkers = []; //Array to store markers near route
        let  directionsService, directionsRenderer;
        function initMap() {

            // Create a map
            const map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 16.49495164522174, lng: 80.49914285090084 }, // 
                zoom: 16,
            });

            // URL to your traffic light icon (can be a local or online image)
            const trafficLightIcon = {
                url: 'images/traffic.jpg', // Example traffic light icon
                scaledSize: new google.maps.Size(30, 30), // Scale the image size
                origin: new google.maps.Point(0, 0), // Origin of the image (top-left corner)
                anchor: new google.maps.Point(10, 10), // Anchor (where the marker points)
            };

            // Array containing data for multiple markers
            const markerData = [
                { lat: 16.495479534913425, lng: 80.49909334109668 }, // Marker 1 16.495479534913425, 80.49909334109668
                { lat: 16.495548099999574, lng: 80.49917713023378 }, // Marker 2 16.495548099999574, 80.49917713023378
                { lat: 16.495462587162848, lng: 80.49923680938495 }, // Marker 3 16.495462587162848, 80.49923680938495
                { lat: 16.49491244887476, lng: 80.50003077315658 },  // Marker 4 16.49491244887476, 80.50003077315658
                { lat: 16.494891874291625, lng: 80.50013001488927 }, // Marker 5 16.494891874291625, 80.50013001488927
                { lat: 16.494167030902517, lng: 80.49850456631789}   // Marker 6 16.494167030902517, 80.49850456631789
            ];

            // Loop through the markerData array to create markers
            markerData.forEach((data, index) => {
                const marker = new google.maps.Marker({
                    position: { lat: data.lat, lng: data.lng },
                    map: map,
                    icon: trafficLightIcon, 
                    title: `Marker ${index + 1}`,  // e.g., "Marker 1", "Marker 2", etc.
                });

                // Store the marker in the array
                markers.push(marker);
            });

            // Initialize Directions Service and Renderer
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);

            // Listen for form submission to calculate the route
            document.getElementById('route-form').addEventListener('submit', function (event) {
                event.preventDefault(); // Prevent page reload
                calculateAndDisplayRoute();
            }); 
        }

        function calculateAndDisplayRoute() {
            const start = document.getElementById('start').value;
            const end = document.getElementById('end').value;

            if (start && end) {
                directionsService.route(
                    {
                        origin: start,   // Start location input by user
                        destination: end, // Destination input by user
                        travelMode: 'DRIVING', // Can use 'WALKING', 'BICYCLING', 'TRANSIT'
                    },
                    (response, status) => {
                        if (status === 'OK') {
                            directionsRenderer.setDirections(response); // Display the route on the map

                            // Extract the route path from the response
                            const routePath = response.routes[0].overview_path;

                            // Check markers on the route
                            checkMarkersOnRoute(routePath);
                        } else {
                            window.alert('Directions request failed due to ' + status);
                        }
                    }
                );
            } 
            else {
                alert('Please enter both start and end locations.');
            }
        }

        function checkMarkersOnRoute(routePath) {
            const distanceThreshold = 20; // Set threshold to 50 meters

            markers.forEach(marker => {
                const markerPosition = marker.getPosition();
                let isOnRoute = false;

                // Loop through the route path and check if marker is near any segment
                routePath.forEach(routePoint => {
                    const distance = google.maps.geometry.spherical.computeDistanceBetween(markerPosition, routePoint);
                    if (distance < distanceThreshold) {
                        isOnRoute = true;
                    }
                });

                if (isOnRoute) {
                    console.log(`Marker ${marker.getTitle()} is on or near the route.`);
                    nearbymarkers.push(marker);
                }
            });

            startSendingMarkerValues();
        }

        // Function to continuously send marker values
        function startSendingMarkerValues() {
            setInterval(() => {
                nearbymarkers.forEach(marker => {
                    const markerValue = extractMarkerValue(marker);
                    console.log(`Sending Marker Value: ${markerValue}`);
                    // Send the value to the ESP32 based on the marker value
                    sendLaneValue(markerValue);
                });
            }, 5000); // Sends marker values every 5 seconds
        }

        // Function to extract the integer value from the marker title
        function extractMarkerValue(marker) {
            const markerTitle = marker.getTitle(); // Get the title (e.g., "Marker 1")
            const markerNumber = markerTitle.substring(7); // Extract number using substring

            // Convert it to an integer
            return parseInt(markerNumber);
        }

        // Function to map lane values to ESP32 IPs and send values
        function sendLaneValue(lane) {
            // Define the mapping of lane values to ESP32 IP addresses
            const esp32Mapping = {
                1: 'YOUR_ESP32_IP_1', // Replace with your first ESP32 IP address
                2: 'YOUR_ESP32_IP_2', // Replace with your second ESP32 IP address
                // Add more mappings as needed
            };

            // Select the ESP32 IP based on the lane value
            const esp32IP = esp32Mapping[lane];

            if (esp32IP) {
                const url = `http://${esp32IP}/set_lights?lane=${lane}`;

                // Send HTTP GET request
                fetch(url)
                    .then(response => response.text())
                    .then(data => {
                        console.log(`Response from ESP32 ${esp32IP}:`, data);
                    })
                    .catch(error => {
                        console.error('Error sending signal:', error);
                    });
            } else {
                console.error('No ESP32 mapping found for lane:', lane);
            }
        }
        // Initialize the map when the page loads
        window.onload = () => {
            initMap();
        };
    </script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            height: fit-content; /* Full height of the viewport */
            width: 100%; /* Full width */
            z-index: 0;
            position: relative; /* To position the form */
        }
        #route-form {
            position: absolute;
            bottom: 35px; /* Distance from the bottom */
            left: 1px; /* Distance from the left */
            background: rgba(255, 255, 255, 0); /* Semi-transparent background */
            padding: 10px;
            z-index: 1;
        }
        #start, #end {
            width: 250px;
            height: 30px;
            margin: 5px 0; /* Space between inputs */
            bottom: 10px;
            border-radius: 10px;
            border-color: rgb(255,255,255);
        }
        #start, #end :active{
            width: 250px;
            height: 30px;
            margin: 5px 0; /* Space between inputs */
            bottom: 10px;
            border-radius: 10px;
            border-color: rgba(0,0,0,0.5);
        }
        #sub:hover {
            background-color: rgb(82, 182, 182);
        }
    </style>
</head>
<body>
    <!-- Sign Out Button -->
    <button id="sign-out-btn" onclick="signOut()">Sign Out</button>

    <!-- Route search form -->
    <form id="route-form" style="margin-bottom: 10px;">
        <input id="start" type="text" placeholder="Enter starting location" ></br>
        <input id="end" type="text" placeholder="Enter destination">
        <button id="sub" type="submit" style="height:30px; border-radius: 30px; ">Get Route</button>
    </form>
    <div id="map" style="height: 642px; width: 100%;"></div>
    
</body>
</html>
