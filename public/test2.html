<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=geometry"></script>
    <script>
        let markers = []; // Array to store marker references
        let directionsService, directionsRenderer;

        function initMap() {
            const map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 16.49495164522174, lng: 80.49914285090084 }, // Default location
                zoom: 16,
            });

            // URL to your traffic light icon (can be a local or online image)
            const trafficLightIcon = {
                url: './images/traffic.jpg', // Example traffic light icon
                scaledSize: new google.maps.Size(30, 30), // Scale the image size
                origin: new google.maps.Point(0, 0), // Origin of the image (top-left corner)
                anchor: new google.maps.Point(10, 10), // Anchor (where the marker points)
            };

            // Array containing data for multiple markers
            const markerData = [
                { lat: 16.495479534913425, lng: 80.49909334109668 },
                { lat: 16.495548099999574, lng: 80.49917713023378 },
                { lat: 16.495462587162848, lng: 80.49923680938495 },
                { lat: 16.49491244887476, lng: 80.50003077315658 },
                { lat: 16.494891874291625, lng: 80.50013001488927 },
                { lat: 16.494167030902517, lng: 80.49850456631789 }
            ];

            // Loop through the markerData array to create markers
            markerData.forEach((data, index) => {
                const marker = new google.maps.Marker({
                    position: { lat: data.lat, lng: data.lng },
                    map: map,
                    icon: trafficLightIcon,
                    title: `Marker ${index + 1}`,
                });

                markers.push(marker);
            });

            // Initialize Directions Service and Renderer
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);

            // Listen for form submission to calculate the route
            document.getElementById('route-form').addEventListener('submit', function (event) {
                event.preventDefault(); // Prevent page reload
                calculateAndDisplayRoute();
            });
        }

        function calculateAndDisplayRoute() {
            const start = document.getElementById('start').value;
            const end = document.getElementById('end').value;

            if (start && end) {
                directionsService.route(
                    {
                        origin: start,
                        destination: end,
                        travelMode: 'DRIVING',
                    },
                    (response, status) => {
                        if (status === 'OK') {
                            directionsRenderer.setDirections(response); // Display the route
                            checkMarkersOnRoute(response.routes[0].overview_path); // Check markers on the route
                        } else {
                            window.alert('Directions request failed due to ' + status);
                        }
                    }
                );
            } else {
                alert('Please enter both start and end locations.');
            }
        }

        function checkMarkersOnRoute(routePath) {
            const distanceThreshold = 50; // Set threshold to 50 meters

            markers.forEach(marker => {
                const markerPosition = marker.getPosition();
                let isOnRoute = false;

                // Loop through the route path and check if marker is near any segment
                routePath.forEach(routePoint => {
                    const distance = google.maps.geometry.spherical.computeDistanceBetween(markerPosition, routePoint);
                    if (distance < distanceThreshold) {
                        isOnRoute = true;
                    }
                });

                if (isOnRoute) {
                    console.log(`Marker ${marker.getTitle()} is on or near the route.`);
                    // Call your function and pass marker value
                    handleMarkerDetection(marker.getTitle());
                }
            });
        }

        function handleMarkerDetection(markerTitle) {
            // Handle detected marker here (e.g., send value to ESP32)
            console.log(`Detected Marker: ${markerTitle}`);
            // Add your logic here to send the marker value or perform any action.
        }

        window.onload = () => {
            initMap();
        };
    </script>
</head>
<body>

    <div>
        <h2>Enter Start and End Locations:</h2>
        <form id="route-form">
            <input type="text" id="start" placeholder="Enter start location" style="width: 250px;">
            <input type="text" id="end" placeholder="Enter destination" style="width: 250px;">
            <button type="submit">Get Route</button>
        </form>
    </div>

    <div id="map" style="height: 600px; width: 100%;"></div>

</body>
</html>
